<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Bankroll Scommesse Sportive</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            margin-bottom: 10px;
        }

        .budget-section {
            background: #e8f4fc;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .budget-input {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .budget-input label {
            font-weight: bold;
        }

        .budget-input input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }

        .budget-input button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .budget-input button:hover {
            background: #219653;
        }

        .strategy-section {
            background: #fff9e6;
            padding: 15px;
            margin: 0 20px 20px;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .strategy-group {
            display: flex;
            flex-direction: column;
        }

        .strategy-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .strategy-group select, .strategy-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .stake-recommendation {
            background: #e8f4fc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        .stake-recommendation h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stake-amount {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
            margin: 10px 0;
        }

        .stake-explanation {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .form-section {
            padding: 20px;
            background: #f9f9f9;
            margin: 0 20px 20px;
            border-radius: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn-add {
            background: #3498db;
            color: white;
        }

        .btn-add:hover {
            background: #2980b9;
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background: #c0392b;
        }

        .btn-apply-stake {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-apply-stake:hover {
            background: #219653;
        }

        .table-section {
            padding: 0 20px 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .profit {
            color: #27ae60;
            font-weight: bold;
        }

        .loss {
            color: #e74c3c;
            font-weight: bold;
        }

        .won {
            color: #27ae60;
            font-weight: bold;
        }

        .lost {
            color: #e74c3c;
            font-weight: bold;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .summary {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            margin: 0 20px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
        }

        .summary-label {
            font-size: 14px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .form-grid, .strategy-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                justify-content: stretch;
            }
            
            .button-group button {
                flex: 1;
            }
            
            .summary {
                flex-direction: column;
                align-items: center;
            }
            
            .budget-input {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .budget-input input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gestione Bankroll Scommesse</h1>
            <p>Calcola lo stake ottimale e traccia il tuo bankroll</p>
        </header>

        <section class="budget-section">
            <div class="budget-input">
                <label for="initial-budget">Budget Iniziale (€):</label>
                <input type="number" id="initial-budget" placeholder="1000.00" step="0.01" min="0">
                <button id="set-budget-btn">Imposta Budget</button>
            </div>
        </section>

        <section class="strategy-section">
            <h2>Strategia di Scommessa</h2>
            <div class="strategy-grid">
                <div class="strategy-group">
                    <label for="strategy-type">Tipo di Strategia</label>
                    <select id="strategy-type">
                        <option value="kelly">Criterio di Kelly (Ottimale)</option>
                        <option value="fractional">Kelly Frazionario (Conservativo)</option>
                        <option value="fixed">Percentuale Fissa</option>
                    </select>
                </div>
                <div class="strategy-group">
                    <label for="risk-level">Livello di Rischio</label>
                    <select id="risk-level">
                        <option value="0.25">Molto Conservativo (25%)</option>
                        <option value="0.5">Conservativo (50%)</option>
                        <option value="1" selected>Normale (100%)</option>
                        <option value="1.5">Aggressivo (150%)</option>
                    </select>
                </div>
                <div class="strategy-group">
                    <label for="fixed-percentage">Percentuale Fissa (%)</label>
                    <input type="number" id="fixed-percentage" placeholder="2" step="0.1" min="0.1" max="100" value="2">
                </div>
                <div class="strategy-group">
                    <label for="win-probability">Probabilità di Vincita (%)</label>
                    <input type="number" id="win-probability" placeholder="50" step="0.1" min="1" max="99" value="50">
                </div>
            </div>
            
            <div class="stake-recommendation">
                <h3>Stake Consigliato</h3>
                <div class="stake-amount" id="recommended-stake">€ 0.00</div>
                <button class="btn-apply-stake" id="apply-stake-btn">Applica Stake Consigliato</button>
                <div class="stake-explanation" id="stake-explanation">
                    Inserisci quota e probabilità per calcolare lo stake ottimale
                </div>
            </div>
        </section>

        <section class="form-section">
            <h2>Nuova Scommessa</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="bet-date">Data</label>
                    <input type="date" id="bet-date">
                </div>
                <div class="form-group">
                    <label for="bet-event">Evento</label>
                    <input type="text" id="bet-event" placeholder="Es. Juventus - Milan">
                </div>
                <div class="form-group">
                    <label for="bet-type">Tipo di Scommessa</label>
                    <input type="text" id="bet-type" placeholder="Es. 1X2, Over/Under">
                </div>
                <div class="form-group">
                    <label for="bet-stake">Stake (€)</label>
                    <input type="number" id="bet-stake" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="bet-odds">Quota</label>
                    <input type="number" id="bet-odds" placeholder="0.00" step="0.01" min="1">
                </div>
                <div class="form-group">
                    <label for="bet-result">Esito</label>
                    <select id="bet-result">
                        <option value="Vinto">Vinto</option>
                        <option value="Perso">Perso</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-reset" id="reset-form-btn">Reset</button>
                <button class="btn-add" id="add-bet-btn">Aggiungi Scommessa</button>
            </div>
        </section>

        <section class="summary">
            <div class="summary-item">
                <span class="summary-value" id="current-balance">€ 0.00</span>
                <span class="summary-label">Saldo Attuale</span>
            </div>
            <div class="summary-item">
                <span class="summary-value" id="total-bets">0</span>
                <span class="summary-label">Totale Scommesse</span>
            </div>
            <div class="summary-item">
                <span class="summary-value" id="win-rate">0%</span>
                <span class="summary-label">Win Rate</span>
            </div>
            <div class="summary-item">
                <span class="summary-value" id="total-profit">€ 0.00</span>
                <span class="summary-label">Profitto Totale</span>
            </div>
        </section>

        <section class="table-section">
            <table id="bets-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Evento</th>
                        <th>Tipo</th>
                        <th>Stake (€)</th>
                        <th>Quota</th>
                        <th>Esito</th>
                        <th>Profitto/Perdita (€)</th>
                        <th>Saldo (€)</th>
                        <th>Azione</th>
                    </tr>
                </thead>
                <tbody id="bets-table-body">
                    <!-- Le righe verranno aggiunte dinamicamente -->
                </tbody>
            </table>
        </section>
    </div>

    <script>
        // Variabili globali
        let initialBudget = 0;
        let currentBalance = 0;
        let bets = [];
        let nextId = 1;

        // Elementi DOM
        const initialBudgetInput = document.getElementById('initial-budget');
        const setBudgetBtn = document.getElementById('set-budget-btn');
        const strategyTypeInput = document.getElementById('strategy-type');
        const riskLevelInput = document.getElementById('risk-level');
        const fixedPercentageInput = document.getElementById('fixed-percentage');
        const winProbabilityInput = document.getElementById('win-probability');
        const recommendedStakeEl = document.getElementById('recommended-stake');
        const applyStakeBtn = document.getElementById('apply-stake-btn');
        const stakeExplanationEl = document.getElementById('stake-explanation');
        const betDateInput = document.getElementById('bet-date');
        const betEventInput = document.getElementById('bet-event');
        const betTypeInput = document.getElementById('bet-type');
        const betStakeInput = document.getElementById('bet-stake');
        const betOddsInput = document.getElementById('bet-odds');
        const betResultInput = document.getElementById('bet-result');
        const addBetBtn = document.getElementById('add-bet-btn');
        const resetFormBtn = document.getElementById('reset-form-btn');
        const betsTableBody = document.getElementById('bets-table-body');
        const currentBalanceEl = document.getElementById('current-balance');
        const totalBetsEl = document.getElementById('total-bets');
        const winRateEl = document.getElementById('win-rate');
        const totalProfitEl = document.getElementById('total-profit');

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Imposta la data di oggi come default
            const today = new Date().toISOString().split('T')[0];
            betDateInput.value = today;
            
            // Carica dati dal localStorage se presenti
            loadFromLocalStorage();
            updateUI();
            
            // Aggiungi listener per il calcolo dello stake
            addStakeCalculationListeners();
            
            // Calcola lo stake iniziale
            calculateRecommendedStake();
        });

        // Imposta il budget iniziale
        setBudgetBtn.addEventListener('click', function() {
            const budget = parseFloat(initialBudgetInput.value);
            if (isNaN(budget) || budget <= 0) {
                alert('Inserisci un budget valido');
                return;
            }
            
            initialBudget = budget;
            currentBalance = budget;
            updateUI();
            calculateRecommendedStake();
            saveToLocalStorage();
            alert(`Budget impostato a € ${budget.toFixed(2)}`);
        });

        // Aggiungi listener per il calcolo dello stake
        function addStakeCalculationListeners() {
            strategyTypeInput.addEventListener('change', calculateRecommendedStake);
            riskLevelInput.addEventListener('change', calculateRecommendedStake);
            fixedPercentageInput.addEventListener('input', calculateRecommendedStake);
            winProbabilityInput.addEventListener('input', calculateRecommendedStake);
            betOddsInput.addEventListener('input', calculateRecommendedStake);
            initialBudgetInput.addEventListener('input', calculateRecommendedStake);
        }

        // Calcola lo stake consigliato
        function calculateRecommendedStake() {
            const odds = parseFloat(betOddsInput.value);
            const winProbability = parseFloat(winProbabilityInput.value) / 100;
            const strategyType = strategyTypeInput.value;
            const riskLevel = parseFloat(riskLevelInput.value);
            const fixedPercentage = parseFloat(fixedPercentageInput.value) / 100;
            
            let recommendedStake = 0;
            let explanation = "";
            
            if (currentBalance <= 0 || isNaN(odds) || odds < 1) {
                recommendedStakeEl.textContent = "€ 0.00";
                stakeExplanationEl.textContent = "Inserisci un budget e una quota valida";
                return;
            }
            
            if (strategyType === 'fixed') {
                // Strategia a percentuale fissa
                recommendedStake = currentBalance * fixedPercentage;
                explanation = `Stake calcolato come ${(fixedPercentage * 100).toFixed(1)}% del bankroll (€${currentBalance.toFixed(2)})`;
            } else {
                // Utilizza il Criterio di Kelly
                if (isNaN(winProbability) || winProbability <= 0 || winProbability >= 1) {
                    recommendedStakeEl.textContent = "€ 0.00";
                    stakeExplanationEl.textContent = "Inserisci una probabilità di vincita valida (tra 1% e 99%)";
                    return;
                }
                
                // Formula di Kelly: f = (bp - q) / b
                // dove b = quota - 1, p = probabilità di vincita, q = probabilità di perdita (1-p)
                const b = odds - 1;
                const p = winProbability;
                const q = 1 - p;
                const kellyFraction = (b * p - q) / b;
                
                if (kellyFraction <= 0) {
                    recommendedStake = 0;
                    explanation = "Secondo il criterio di Kelly, questa scommessa non ha valore atteso positivo";
                } else {
                    let fractionToUse = kellyFraction;
                    
                    if (strategyType === 'fractional') {
                        // Kelly frazionario - usa una frazione del criterio di Kelly completo
                        fractionToUse = kellyFraction * 0.5; // Usa il 50% del criterio di Kelly
                    }
                    
                    // Applica il livello di rischio
                    fractionToUse = fractionToUse * riskLevel;
                    
                    // RIMOSSO: Limite di sicurezza del 25%
                    // fractionToUse = Math.min(fractionToUse, 0.25);
                    
                    recommendedStake = currentBalance * fractionToUse;
                    
                    let strategyName = strategyType === 'kelly' ? 'Criterio di Kelly completo' : 'Kelly frazionario (50%)';
                    explanation = `${strategyName} con rischio ${(riskLevel * 100).toFixed(0)}%. Valore Kelly: ${(kellyFraction * 100).toFixed(2)}%`;
                }
            }
            
            // Arrotonda a 2 decimali e assicurati che non sia negativo
            recommendedStake = Math.max(0, parseFloat(recommendedStake.toFixed(2)));
            
            recommendedStakeEl.textContent = `€ ${recommendedStake.toFixed(2)}`;
            stakeExplanationEl.textContent = explanation;
        }

        // Applica lo stake consigliato
        applyStakeBtn.addEventListener('click', function() {
            const recommendedStakeText = recommendedStakeEl.textContent.replace('€', '').trim();
            const recommendedStake = parseFloat(recommendedStakeText);
            
            if (recommendedStake > 0) {
                betStakeInput.value = recommendedStake.toFixed(2);
            } else {
                alert('Calcola prima uno stake valido');
            }
        });

        // Aggiungi una nuova scommessa
        addBetBtn.addEventListener('click', function() {
            if (initialBudget === 0) {
                alert('Prima imposta il budget iniziale');
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            const bet = {
                id: nextId++,
                date: betDateInput.value,
                event: betEventInput.value,
                type: betTypeInput.value,
                stake: parseFloat(betStakeInput.value),
                odds: parseFloat(betOddsInput.value),
                result: betResultInput.value
            };
            
            // Calcola profitto/perdita
            if (bet.result === 'Vinto') {
                bet.profit = (bet.stake * bet.odds) - bet.stake;
            } else {
                bet.profit = -bet.stake;
            }
            
            // Aggiorna il saldo
            currentBalance += bet.profit;
            bet.balanceAfter = currentBalance;
            
            // Aggiungi alla lista
            bets.push(bet);
            
            // Aggiorna l'UI
            updateUI();
            calculateRecommendedStake();
            saveToLocalStorage();
            resetForm();
        });

        // Reset del form
        resetFormBtn.addEventListener('click', resetForm);

        // Funzione per validare il form
        function validateForm() {
            if (!betDateInput.value) {
                alert('Inserisci la data');
                return false;
            }
            
            if (!betEventInput.value.trim()) {
                alert('Inserisci l\'evento');
                return false;
            }
            
            if (!betTypeInput.value.trim()) {
                alert('Inserisci il tipo di scommessa');
                return false;
            }
            
            const stake = parseFloat(betStakeInput.value);
            if (isNaN(stake) || stake <= 0) {
                alert('Inserisci uno stake valido');
                return false;
            }
            
            if (stake > currentBalance) {
                alert('Lo stake non può superare il saldo disponibile');
                return false;
            }
            
            const odds = parseFloat(betOddsInput.value);
            if (isNaN(odds) || odds < 1) {
                alert('Inserisci una quota valida (minimo 1.00)');
                return false;
            }
            
            return true;
        }

        // Reset del form di inserimento
        function resetForm() {
            betEventInput.value = '';
            betTypeInput.value = '';
            betStakeInput.value = '';
            betOddsInput.value = '';
            betResultInput.value = 'Vinto';
            winProbabilityInput.value = '50';
            
            // Reimposta la data a oggi
            const today = new Date().toISOString().split('T')[0];
            betDateInput.value = today;
            
            // Ricalcola lo stake consigliato
            calculateRecommendedStake();
        }

        // Elimina una scommessa
        function deleteBet(id) {
            if (!confirm('Sei sicuro di voler eliminare questa scommessa?')) {
                return;
            }
            
            // Trova l'indice della scommessa
            const index = bets.findIndex(bet => bet.id === id);
            if (index === -1) return;
            
            // Rimuovi la scommessa
            const deletedBet = bets.splice(index, 1)[0];
            
            // Ricalcola il saldo
            recalculateBalance();
            
            // Aggiorna l'UI
            updateUI();
            calculateRecommendedStake();
            saveToLocalStorage();
        }

        // Ricalcola il saldo dopo l'eliminazione
        function recalculateBalance() {
            currentBalance = initialBudget;
            bets.forEach(bet => {
                currentBalance += bet.profit;
                bet.balanceAfter = currentBalance;
            });
        }

        // Aggiorna l'interfaccia utente
        function updateUI() {
            updateTable();
            updateSummary();
        }

        // Aggiorna la tabella
        function updateTable() {
            betsTableBody.innerHTML = '';
            
            if (bets.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px;">Nessuna scommessa inserita</td>`;
                betsTableBody.appendChild(row);
                return;
            }
            
            bets.forEach(bet => {
                const row = document.createElement('tr');
                
                // Formatta la data in formato italiano
                const dateObj = new Date(bet.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('it-IT');
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${bet.event}</td>
                    <td>${bet.type}</td>
                    <td>${bet.stake.toFixed(2)}</td>
                    <td>${bet.odds.toFixed(2)}</td>
                    <td class="${bet.result === 'Vinto' ? 'won' : 'lost'}">${bet.result}</td>
                    <td class="${bet.profit >= 0 ? 'profit' : 'loss'}">
                        ${bet.profit >= 0 ? '+' : ''}${bet.profit.toFixed(2)}
                    </td>
                    <td>${bet.balanceAfter.toFixed(2)}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteBet(${bet.id})">Elimina</button>
                    </td>
                `;
                
                betsTableBody.appendChild(row);
            });
        }

        // Aggiorna il riepilogo
        function updateSummary() {
            currentBalanceEl.textContent = `€ ${currentBalance.toFixed(2)}`;
            totalBetsEl.textContent = bets.length;
            
            // Calcola win rate
            const wonBets = bets.filter(bet => bet.result === 'Vinto').length;
            const winRate = bets.length > 0 ? (wonBets / bets.length * 100) : 0;
            winRateEl.textContent = `${winRate.toFixed(1)}%`;
            
            // Calcola profitto totale
            const totalProfit = currentBalance - initialBudget;
            totalProfitEl.textContent = `€ ${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)}`;
            totalProfitEl.className = totalProfit >= 0 ? 'profit' : 'loss';
        }

        // Salva i dati nel localStorage
        function saveToLocalStorage() {
            const data = {
                initialBudget,
                currentBalance,
                bets,
                nextId,
                strategyType: strategyTypeInput.value,
                riskLevel: riskLevelInput.value,
                fixedPercentage: fixedPercentageInput.value,
                winProbability: winProbabilityInput.value
            };
            localStorage.setItem('bettingTracker', JSON.stringify(data));
        }

        // Carica i dati dal localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('bettingTracker');
            if (saved) {
                const data = JSON.parse(saved);
                initialBudget = data.initialBudget || 0;
                currentBalance = data.currentBalance || initialBudget;
                bets = data.bets || [];
                nextId = data.nextId || 1;
                
                // Aggiorna l'input del budget
                initialBudgetInput.value = initialBudget > 0 ? initialBudget : '';
                
                // Aggiorna le impostazioni della strategia
                if (data.strategyType) strategyTypeInput.value = data.strategyType;
                if (data.riskLevel) riskLevelInput.value = data.riskLevel;
                if (data.fixedPercentage) fixedPercentageInput.value = data.fixedPercentage;
                if (data.winProbability) winProbabilityInput.value = data.winProbability;
            }
        }
    </script>
</body>
</html>
